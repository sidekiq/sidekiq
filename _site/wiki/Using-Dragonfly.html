<!DOCTYPE html>
<html>
<head>
  <meta charset="utf8">
  <title>Sidekiq</title>
  <meta name="description" content="Simple, efficient background jobs for Ruby">
  <meta name="twitter:site" content="@sidekiq">
  <meta name="twitter:card" content="summary" />
  <meta property="og:site_name" content="Sidekiq">
  <meta property="og:type" content="company">
  <meta property="og:title" content="Simple, efficient background jobs for Ruby">
  <meta property="og:url" content="//sidekiq.org">
  <meta property="og:image" content="//sidekiq.org/assets/sidekiq.png">
  <meta property="og:description" content="Sidekiq is a simple, efficient framework for background jobs in Ruby">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Armata|Montserrat:400,700">
  <link rel="shortcut icon" type="image/ico" href="/favicon.ico">
  <link rel="me" href="https://ruby.social/@getajobmike">
  <script defer src="/js/jquery.min.js"></script>
  <script defer src="/js/bootstrap.min.js"></script>
  <script defer src="/js/scrollingcarousel.2.0.min.js"></script>
  <script defer src="/js/skq-global.js"></script>
</head>

<body>
  <style>
    h1, h2, h3 { border-bottom: 1px solid black; }
    img { max-width:100%; height: auto; }
  </style>
  <header>
  <nav role="navigation" class="navbar navbar-default navbar-fixed-top default">
    <div class="container-fluid skq-header">
      <div class="navbar-header">
        <a href="/" class="skq navbar-brand">Sidekiq</a><span
          class="default skq-tagline navbar-brand col-sm-5 hidden-md">Simple, efficient background jobs for Ruby.</span>
      </div>
      <div id="navbar-top-collapse-1" class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/" class="skq-nav-link">Back</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>
</header>

  <main class="container">
    <h1>Using Dragonfly</h1>
    <p class="small">Last synchronized at 2025-12-15 15:43:00 -0800</p>
    <div class="row">
      <div class="col-md-9"><p>Sidekiq can use <a href="https://github.com/dragonflydb/dragonfly">Dragonfly</a>, an open-source in-memory data store compatible with Redis APIs, to store all the job and operational data.
By default, Sidekiq connects to <code class="language-plaintext highlighter-rouge">localhost:6379</code>. Since Dragonfly is 100% compatible with Redis clients, your connection configuration will look identical to what Redis requires.
In terms of other server configurations, Dragonfly exposes different flags and options to tune the server for your specific use case.</p>

<p><strong>Note: The Sidekiq-Dragonfly integration requires Dragonfly v1.13+.</strong></p>

<h2 id="using-an-env-variable">Using an ENV variable</h2>

<p>You can configure Dragonfly’s location using an environment variable.
The easiest option is to set <code class="language-plaintext highlighter-rouge">REDIS_URL</code>; Sidekiq will pick it up and use it to connect to the backend store.
It is just that in this case, the backend store is Dragonfly, which is wire-compatible with Redis.
A Redis URL looks like <code class="language-plaintext highlighter-rouge">redis://[hostname]:[port]/[dbnumber]</code>, e.g. <code class="language-plaintext highlighter-rouge">redis://my.dragonfly.instance.com:7777/0</code>.</p>

<h2 id="using-an-initializer">Using an initializer</h2>

<p>Prefer to use the ENV variables above.
If you have to use logic in Ruby, you can configure the connection in the initializer.
Note that to configure the location of Dragonfly, you must define <em>both</em> the <code class="language-plaintext highlighter-rouge">Sidekiq.configure_server</code> and <code class="language-plaintext highlighter-rouge">Sidekiq.configure_client</code> blocks.
To do this, put the following code into <code class="language-plaintext highlighter-rouge">config/initializers/sidekiq.rb</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Sidekiq</span><span class="p">.</span><span class="nf">configure_server</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">redis</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">url: </span><span class="s1">'redis://my.dragonfly.instance.com:7777/0'</span> <span class="p">}</span>
<span class="k">end</span>

<span class="no">Sidekiq</span><span class="p">.</span><span class="nf">configure_client</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">redis</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">url: </span><span class="s1">'redis://my.dragonfly.instance.com:7777/0'</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Unknown parameters are passed to the underlying Redis client, so any parameters supported by the driver can go in the Hash.
Keys can be strings or symbols and will be unified before being passed on to the Redis client.</p>

<h2 id="life-in-the-cloud">Life in the Cloud</h2>

<p>One problem with cloud-based systems like EC2 and Heroku can be multi-tenancy and unpredictable network performance.
You can tune your network and pool timeouts to be a little more lenient if you are seeing occasional timeout errors, it defaults to 1 second.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span><span class="p">.</span><span class="nf">redis</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">url: </span><span class="s1">'redis://...'</span><span class="p">,</span> <span class="ss">network_timeout: </span><span class="mi">5</span><span class="p">,</span> <span class="ss">pool_timeout: </span><span class="mi">5</span> <span class="p">}</span>
</code></pre></div></div>

<p><strong>REMEMBER: THIS IS A BANDAID</strong> You are not solving the actual cause of the slow performance.</p>

<p>If you are seeing Dragonfly timeout errors, you should check your Dragonfly instance latency by using the <code class="language-plaintext highlighter-rouge">redis-cli</code> <code class="language-plaintext highlighter-rouge">--latency</code> and <code class="language-plaintext highlighter-rouge">--latency-history</code> flags:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ redis-cli --latency-history localhost
min: 0, max: 1, avg: 0.20 (1359 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.18 (1356 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.18 (1355 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.17 (1359 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.19 (1358 samples) -- 15.00 seconds range
min: 0, max: 1, avg: 0.18 (1353 samples) -- 15.01 seconds range
min: 0, max: 1, avg: 0.19 (1357 samples) -- 15.01 seconds range
</code></pre></div></div>

<p>This says my average latency to localhost is 0.2ms or 200 microseconds: excellent.  Note that a 5-second timeout configuration is terrible.  You can move to a different Cloud service provider or run your own Dragonfly server on a dedicated machine, but there’s nothing Sidekiq can do if the network performance is terrible.  Contact your Cloud provider and ask about your available options.</p>

<h2 id="architecture">Architecture</h2>

<p>Dragonfly is developed from the ground up with a multi-threaded shared-nothing architecture, which can utilize all the CPU cores and memory of modern servers.</p>

<p>Dragonfly offers many different topologies:</p>

<ul>
  <li>Standalone – offers no fault tolerance</li>
  <li>Primary/Replica – manually fails over to a replica in case of primary failure</li>
  <li>Primary/Replica managed by Sentinel – automatically fails over to a replica in case of primary failure</li>
  <li>Primary/Replica managed by Kubernetes – automatically fails over to a replica in case of primary failure</li>
</ul>

<p>Depending on your requirements, you can choose the best topology for your use case.
At the moment of writing (January 2024, Dragonfly v1.14.1), Dragonfly does not support multi-instance cluster mode like Redis Cluster.
However, it is notable that <strong>Redis Cluster is not appropriate</strong> for Sidekiq as Sidekiq has a few very hot keys which are constantly changing (aka queues) and Cluster cannot guarantee high-performance transactions,
necessary to keep your job system fast and consistent.</p>

<p>On the other hand, Dragonfly is able to handle large datasets (up to 1TB) and fully utilize the hardware resources of a single server.
This makes Dragonfly a viable option for Sidekiq users who need to process large amounts of jobs.</p>

<h2 id="tuning">Tuning</h2>

<p>You can see Dragonfly’s <a href="https://www.dragonflydb.io/docs/managing-dragonfly/flags">server flags</a> for performance tuning,
specifically the <code class="language-plaintext highlighter-rouge">--shard_round_robin_prefix</code> server flag, with more explanation <a href="https://www.dragonflydb.io/docs/integrations/sidekiq">here</a>.</p>

<h2 id="scale">Scale</h2>

<p>The Sidekiq benchmark was slightly revamped in <code class="language-plaintext highlighter-rouge">bin/multi_queue_bench</code> to scale better with multi-threaded systems like Dragonfly.
We used an AWS <code class="language-plaintext highlighter-rouge">c5.4xlarge</code> to run Dragonfly and a monstrous 96-core <code class="language-plaintext highlighter-rouge">c5a.24xlarge</code> to run the benchmark.
All job types are no-op <code class="language-plaintext highlighter-rouge">Sidekiq::Job</code>.
We run Dragonfly with <code class="language-plaintext highlighter-rouge">dragonfly --proactor_threads=n --shard_round_robin_prefix="queue"</code>, where <code class="language-plaintext highlighter-rouge">n</code> is the number of threads that Dragonfly uses.
This is different from Redis, which is single-threaded and scales horizontally via Redis Cluster.
To fully demonstrate performance and scalability, we ran the benchmark with 3 different setups: <code class="language-plaintext highlighter-rouge">RUBY_YJIT_ENABLE=1 PROCESSES=96 QUEUES=k THREADS=10 ./multi_queue_bench</code>, with <code class="language-plaintext highlighter-rouge">k=1, 2, 8</code>.
We used Ruby with version 3.3.0 and Sidekiq trunk.</p>

<p>The results are as follows:</p>

<table>
  <thead>
    <tr>
      <th>Dragonfly Threads (n)</th>
      <th>Number of Queues (k)</th>
      <th>Jobs per Queue</th>
      <th>Total Jobs</th>
      <th>Throughput (Jobs/Sec)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>1M</td>
      <td>1M</td>
      <td>115,528</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
      <td>1M</td>
      <td>2M</td>
      <td>241,259</td>
    </tr>
    <tr>
      <td>8</td>
      <td>8</td>
      <td>1M</td>
      <td>8M</td>
      <td>487,781</td>
    </tr>
  </tbody>
</table>

<h2 id="memory">Memory</h2>

<p>Dragonfly runs best when all data fits in memory (i.e., no swapping).
You should set the <code class="language-plaintext highlighter-rouge">--cache_mode</code> server flag to <code class="language-plaintext highlighter-rouge">false</code> so Dragonfly doesn’t drop Sidekiq’s data silently.</p>

<h2 id="multiple-dragonfly-instances">Multiple Dragonfly instances</h2>

<p>It is recommended to run Sidekiq with a dedicated Dragonfly instance.
If you are also using Dragonfly for other purposes, such as caching, you should run a separate Dragonfly instance for Sidekiq.
This would avoid potential issues such as cache eviction, conflicting configurations, and performance degradation.</p>

<h2 id="notes">Notes</h2>

<ul>
  <li><code class="language-plaintext highlighter-rouge">redis-cli --help</code> shows several useful options, including <code class="language-plaintext highlighter-rouge">--latency-history</code> and <code class="language-plaintext highlighter-rouge">--bigkeys</code>, which can be used with Dragonfly.</li>
  <li><a href="https://www.dragonflydb.io/blog/monitoring-in-memory-datastores">Monitoring In-memory Data Stores</a> covers the most essential things you should monitor when using Dragonfly.</li>
  <li><code class="language-plaintext highlighter-rouge">BRPOPLPUSH</code> and other <code class="language-plaintext highlighter-rouge">B*</code> commands are <strong>blocking</strong>; large latency spikes with them are <strong>normal</strong> and not a cause for concern.</li>
</ul>

<p>Previous: [[Best Practices]] Next: [[Error Handling]]</p>
</div>
      <div class="col-md-3"><h4>Wiki Pages</h4>
<ul>


  <li class="wiki-link"><a href='/wiki/API.html'>API</a></li>

  <li class="wiki-link"><a href='/wiki/Active-Job.html'>Active Job</a></li>

  <li class="wiki-link"><a href='/wiki/Advanced-Options.html'>Advanced Options</a></li>

  <li class="wiki-link"><a href='/wiki/Batches.html'>Batches</a></li>

  <li class="wiki-link"><a href='/wiki/Best-Practices.html'>Best Practices</a></li>

  <li class="wiki-link"><a href='/wiki/Build-vs-Buy.html'>Build vs Buy</a></li>

  <li class="wiki-link"><a href='/wiki/Bulk-Queueing.html'>Bulk Queueing</a></li>

  <li class="wiki-link"><a href='/wiki/Comm-Installation.html'>Comm Installation</a></li>

  <li class="wiki-link"><a href='/wiki/Commercial-FAQ.html'>Commercial FAQ</a></li>

  <li class="wiki-link"><a href='/wiki/Commercial-Support.html'>Commercial Support</a></li>

  <li class="wiki-link"><a href='/wiki/Commercial-collaboration.html'>Commercial collaboration</a></li>

  <li class="wiki-link"><a href='/wiki/Complex-Job-Workflows-with-Batches.html'>Complex Job Workflows with Batches</a></li>

  <li class="wiki-link"><a href='/wiki/Delayed-extensions.html'>Delayed extensions</a></li>

  <li class="wiki-link"><a href='/wiki/Deployment.html'>Deployment</a></li>

  <li class="wiki-link"><a href='/wiki/Devise.html'>Devise</a></li>

  <li class="wiki-link"><a href='/wiki/Embedding.html'>Embedding</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Encryption.html'>Ent Encryption</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Historical-Metrics.html'>Ent Historical Metrics</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Leader-Election.html'>Ent Leader Election</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Multi-Process.html'>Ent Multi Process</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Periodic-Jobs.html'>Ent Periodic Jobs</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Rate-Limiting.html'>Ent Rate Limiting</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Rolling-Restarts.html'>Ent Rolling Restarts</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Unique-Jobs.html'>Ent Unique Jobs</a></li>

  <li class="wiki-link"><a href='/wiki/Ent-Web-UI.html'>Ent Web UI</a></li>

  <li class="wiki-link"><a href='/wiki/Error-Handling.html'>Error Handling</a></li>

  <li class="wiki-link"><a href='/wiki/FAQ.html'>FAQ</a></li>

  <li class="wiki-link"><a href='/wiki/Getting-Started.html'>Getting Started</a></li>

  <li class="wiki-link"><a href='/wiki/Heroku.html'>Heroku</a></li>

  <li class="wiki-link"><a href='/wiki/Home.html'>Home</a></li>

  <li class="wiki-link"><a href='/wiki/Iteration.html'>Iteration</a></li>

  <li class="wiki-link"><a href='/wiki/Job-Format.html'>Job Format</a></li>

  <li class="wiki-link"><a href='/wiki/Job-Lifecycle.html'>Job Lifecycle</a></li>

  <li class="wiki-link"><a href='/wiki/Kubernetes.html'>Kubernetes</a></li>

  <li class="wiki-link"><a href='/wiki/Logging.html'>Logging</a></li>

  <li class="wiki-link"><a href='/wiki/Memory.html'>Memory</a></li>

  <li class="wiki-link"><a href='/wiki/Metrics.html'>Metrics</a></li>

  <li class="wiki-link"><a href='/wiki/Middleware.html'>Middleware</a></li>

  <li class="wiki-link"><a href='/wiki/Miscellaneous-Features.html'>Miscellaneous Features</a></li>

  <li class="wiki-link"><a href='/wiki/Monitoring.html'>Monitoring</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-API.html'>Pro API</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-Expiring-Jobs.html'>Pro Expiring Jobs</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-Metrics.html'>Pro Metrics</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-Reliability-Client.html'>Pro Reliability Client</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-Reliability-Server.html'>Pro Reliability Server</a></li>

  <li class="wiki-link"><a href='/wiki/Pro-Web-UI.html'>Pro Web UI</a></li>

  <li class="wiki-link"><a href='/wiki/Problems-and-Troubleshooting.html'>Problems and Troubleshooting</a></li>

  <li class="wiki-link"><a href='/wiki/Profiling.html'>Profiling</a></li>

  <li class="wiki-link"><a href='/wiki/Really-Complex-Workflows-with-Batches.html'>Really Complex Workflows with Batches</a></li>

  <li class="wiki-link"><a href='/wiki/Related-Projects.html'>Related Projects</a></li>

  <li class="wiki-link"><a href='/wiki/Reliability.html'>Reliability</a></li>

  <li class="wiki-link"><a href='/wiki/Scaling.html'>Scaling</a></li>

  <li class="wiki-link"><a href='/wiki/Scheduled-Jobs.html'>Scheduled Jobs</a></li>

  <li class="wiki-link"><a href='/wiki/Sharding.html'>Sharding</a></li>

  <li class="wiki-link"><a href='/wiki/Signals.html'>Signals</a></li>

  <li class="wiki-link"><a href='/wiki/Testimonials.html'>Testimonials</a></li>

  <li class="wiki-link"><a href='/wiki/Testing.html'>Testing</a></li>

  <li class="wiki-link"><a href='/wiki/The-Basics.html'>The Basics</a></li>

  <li class="wiki-link"><a href='/wiki/Using-Dragonfly.html'>Using Dragonfly</a></li>

  <li class="wiki-link"><a href='/wiki/Using-Redis.html'>Using Redis</a></li>

</ul></div>
    </div>
  </main>
</body>
</html>

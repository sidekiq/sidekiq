<script type="text/javascript" src="<%= root_path %>javascripts/chart.min.js" nonce="<%= csp_nonce %>"></script>
<script type="text/javascript" src="<%= root_path %>javascripts/chartjs-plugin-annotation.min.js" nonce="<%= csp_nonce %>"></script>
<script type="text/javascript" src="<%= root_path %>javascripts/base-charts.js" nonce="<%= csp_nonce %>"></script>

<section>
  <div class="grid">
    <h2><%= t('Metrics') %></h2>
    <div><!-- spacer --></div>
    <nav>
      <ul>
        <li><%= t('MetricsPeriod') %>:</li>
        <li><%= period_link("1h") %></li>
        <li><%= period_link("2h") %></li>
        <li><%= period_link("4h") %></li>
        <li><%= period_link("8h") %></li>
      </ul>
    </nav>
    <form id="metrics-form" role="search" action="<%= root_path %>metrics" method="get">
      <input type="hidden" name="period" value="8h" />
      <input id="class-filter" type="search" name="substr" placeholder="<%= t('Name') %>" value="<%= h url_params("substr") %>">
      <input type="submit" value="<%= t('Search') %>" />
    </form>
  </div>

<%
  table_limit = 20
  chart_limit = 5
  job_results = @query_result.job_results.sort_by { |(kls, jr)| jr.totals["s"] }.reverse.first(table_limit)
  visible_kls = job_results.first(chart_limit).map(&:first)
%>

<% if job_results.any? %>
  <canvas id="job-metrics-overview-chart">
    <%= to_json({
      series: job_results.map { |(kls, jr)| [kls, jr.dig("series", "s")] }.to_h,
      marks: @query_result.marks.map { |m| [m.bucket, m.label] },
      labels: @query_result.buckets,
      visibleKls: visible_kls,
      yLabel: t('TotalExecutionTime'),
      units: t('Seconds').downcase,
      markLabel: t('Deploy'),
    }) %>
  </canvas>
<% end %>

<% if job_results.any? %>
  <table class="striped">
    <tbody>
      <tr>
        <th><%= t('Name') %></th>
        <th><%= t('Success') %></th>
        <th><%= t('Failure') %></th>
        <th><%= t('TotalExecutionTime') %> (<%= t('Seconds') %>)</th>
        <th><%= t('AvgExecutionTime') %> (<%= t('Seconds') %>)</th>
      </tr>
      <% job_results.each_with_index do |(kls, jr), i| %>
        <tr>
          <td>
            <div class="metrics-swatch-wrapper">
              <% id = "metrics-swatch-#{kls}" %>
              <input type="checkbox" id="<%= id %>" class="metrics-swatch" value="<%= kls %>"
                <%= visible_kls.include?(kls) ? 'checked' : '' %>
              />
              <code><a href="<%= root_path %>metrics/<%= kls %>?period=<%= @period %>"><%= kls %></a></code>
            </div>
          </td>
          <td class="num"><%= number_with_delimiter(jr.dig("totals", "p") - jr.dig("totals", "f")) %></td>
          <td class="num"><%= number_with_delimiter(jr.dig("totals", "f")) %></td>
          <td class="num"><%= number_with_delimiter(jr.dig("totals", "s"), precision: 2) %></td>
          <td class="num"><%= number_with_delimiter(jr.total_avg("s"), precision: 2) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
    <p><%= t("NoDataFound") %></p>
<% end %>
</section>

<script type="text/javascript" src="<%= root_path %>javascripts/metrics.js" nonce="<%= csp_nonce %>"></script>
